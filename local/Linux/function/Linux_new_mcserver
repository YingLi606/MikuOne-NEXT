#!/bin/bash
GREEN="\033[92m"
BLUE="\033[94m"
YELLOW="\033[93m"
RED="\033[91m"
RESET="\033[0m"
BASE_DIR="$HOME/.termux/MikuOne-NEXT/MCserver"  

check_commands() {
    echo -e "${BLUE}[æ£€æµ‹] æ­£åœ¨æ£€æŸ¥å¿…è¦å‘½ä»¤...${RESET}"
    local cmds=("whiptail" "wget" "java" "find" "chmod" "rm")
    for cmd in "${cmds[@]}"; do
        if ! command -v "$cmd" &> /dev/null; then
            echo -e "${RED}[é”™è¯¯] ç¼ºå°‘å‘½ä»¤ $cmdï¼Œè¯·å®‰è£…åé‡è¯•ï¼${RESET}"
            sleep 3 && clear && exit 1
        fi
    done
    [ ! -d "$BASE_DIR" ] && { mkdir -p "$BASE_DIR"; chmod 755 "$BASE_DIR"; }
}

check_system() {
    check_commands
    if ! command -v lsb_release &> /dev/null; then
        echo -e "${RED}[é”™è¯¯] æ— lsb_releaseï¼Œæ— æ³•è¯†åˆ«ç³»ç»Ÿï¼${RESET}"
        sleep 5 && clear && exit 1
    fi
    OS=$(lsb_release -is)
    SUPPORTED=("Ubuntu" "Kali" "Debian" "GXDE" "Deepin" "UOS")
    [[ ! " ${SUPPORTED[@]} " =~ " ${OS} " ]] && {
        echo -e "${RED}[é”™è¯¯] ç³»ç»Ÿ${OS}æœªé€‚é…ï¼Œä»…æ”¯æŒ${SUPPORTED[*]}ï¼${RESET}"
        sleep 5 && clear && exit 1
    }
    echo -e "${GREEN}[æˆåŠŸ] é€‚é…ç³»ç»Ÿï¼š${OS}${RESET}"
}

check_java() {
    echo -e "${BLUE}[æ£€æµ‹] æ£€æŸ¥Java 21...${RESET}"
    if command -v java &> /dev/null && java -version 2>&1 | grep -q "21"; then
        echo -e "${GREEN}[æˆåŠŸ] Java 21å·²å®‰è£…${RESET}"
    else
        echo -e "${YELLOW}[æç¤º] æ­£åœ¨å®‰è£…Java 21...${RESET}"
        apt update &> /dev/null && apt install openjdk-21-jre -y &> /dev/null
        if ! java -version 2>&1 | grep -q "21"; then
            echo -e "${RED}[é”™è¯¯] Java 21å®‰è£…å¤±è´¥ï¼${RESET}"
            sleep 5 && clear && exit 1
        fi
    fi
}

install_core() {
    local CORE_JAR="" INSTALL_DIR="" CORE_TYPE="" VERSION=""
    # 1. é€‰æ‹©æœåŠ¡ç«¯ç±»å‹
    CORE=$(whiptail --title "é€‰æœåŠ¡ç«¯ç±»å‹" --menu "è¯·é€‰æ‹©è¦å®‰è£…çš„æœåŠ¡ç«¯" 15 50 4 \
        "1" "Paper" "2" "Spigot" "3" "Nukkit" "4" "Fabric" \
        3>&1 1>&2 2>&3)
    [ -z "$CORE" ] && return

    # 2. æœåŠ¡ç«¯ç‰ˆæœ¬é€‰æ‹©ä¸ä¸‹è½½ï¼ˆä¿ç•™åŸé€»è¾‘ï¼Œç¡®ä¿CORE_JARèµ‹å€¼æ­£ç¡®ï¼‰
    case $CORE in
        1)
            CORE_TYPE="Paper"
            VER=$(whiptail --title "é€‰Paperç‰ˆæœ¬" --menu "é€‰æ‹©1.21å¼€å¤´ç‰ˆæœ¬" 12 40 2 \
                "1" "1.21.9" "2" "1.21.8" \
                3>&1 1>&2 2>&3)
            [ -z "$VER" ] && return
            VERSION=$([ $VER -eq 1 ] && echo "1.21.9" || echo "1.21.8")
            INSTALL_DIR="$BASE_DIR/$CORE_TYPE/$VERSION"  
            CORE_JAR="paper.jar"  # æœåŠ¡ç«¯å¯åŠ¨å™¨JARæ–‡ä»¶å
            mkdir -p "$INSTALL_DIR/plugins" && cd "$INSTALL_DIR"
            echo -e "${BLUE}[ä¸‹è½½] å¼€å§‹ä¸‹è½½Paper $VERSION æ ¸å¿ƒ...${RESET}"
            wget --show-progress "https://meta.fabricmc.net/v2/versions/loader/1.21.9/0.17.2/1.1.0/server/jar" -O "$CORE_JAR"
            ;;
        2)
            CORE_TYPE="Spigot"
            VERSION="1.21.8"
            INSTALL_DIR="$BASE_DIR/$CORE_TYPE/$VERSION"  
            CORE_JAR="spigot.jar"  # æœåŠ¡ç«¯å¯åŠ¨å™¨JARæ–‡ä»¶å
            mkdir -p "$INSTALL_DIR/plugins" && cd "$INSTALL_DIR"
            echo -e "${BLUE}[ä¸‹è½½] å¼€å§‹ä¸‹è½½Spigot $VERSION æ ¸å¿ƒ...${RESET}"
            wget --show-progress "https://cdn.getbukkit.org/spigot/spigot-1.21.8.jar" -O "$CORE_JAR"
            ;;
        3)
            CORE_TYPE="Nukkit"
            VERSION="build1120"
            INSTALL_DIR="$BASE_DIR/$CORE_TYPE/$VERSION"  
            CORE_JAR="nukkit.jar"  # æœåŠ¡ç«¯å¯åŠ¨å™¨JARæ–‡ä»¶å
            mkdir -p "$INSTALL_DIR/plugins" && cd "$INSTALL_DIR"
            echo -e "${BLUE}[ä¸‹è½½] å¼€å§‹ä¸‹è½½Nukkit $VERSION æ ¸å¿ƒ...${RESET}"
            wget --show-progress "https://download.fastmirror.net/download/NukkitX/general/build1120" -O "$CORE_JAR"
            ;;
        4)
            CORE_TYPE="Fabric"
            VER=$(whiptail --title "é€‰Fabricç‰ˆæœ¬" --menu "é€‰æ‹©1.21å¼€å¤´ç‰ˆæœ¬" 12 40 2 \
                "1" "1.21.9" "2" "1.21.8" \
                3>&1 1>&2 2>&3)
            [ -z "$VER" ] && return
            VERSION=$([ $VER -eq 1 ] && echo "1.21.9" || echo "1.21.8")
            INSTALL_DIR="$BASE_DIR/$CORE_TYPE/$VERSION"  
            CORE_JAR="fabric.jar"  # æœåŠ¡ç«¯å¯åŠ¨å™¨JARæ–‡ä»¶å
            mkdir -p "$INSTALL_DIR/plugins" && cd "$INSTALL_DIR"
            echo -e "${BLUE}[ä¸‹è½½] å¼€å§‹ä¸‹è½½Fabric $VERSION æ ¸å¿ƒ...${RESET}"
            wget --show-progress "https://meta.fabricmc.net/v2/versions/loader/$VERSION/0.17.2/1.1.0/server/jar" -O "$CORE_JAR"
            echo -e "${BLUE}[ä¸‹è½½] å¼€å§‹ä¸‹è½½Fabric API $VERSION...${RESET}"
            [ $VER -eq 1 ] && wget --show-progress "https://cdn.modrinth.com/data/P7dR8mSH/versions/iHrvVvaM/fabric-api-0.134.0%2B1.21.9.jar" -O plugins/fabric-api.jar || wget --show-progress "https://cdn.modrinth.com/data/P7dR8mSH/versions/7X7rQ0X7/fabric-api-0.133.1%2B1.21.8.jar" -O plugins/fabric-api.jar
            ;;
    esac

    # 3. è‡ªå®šä¹‰Javaå†…å­˜å‚æ•°ï¼ˆä¿ç•™åŸè¾“å…¥é€»è¾‘ï¼‰
    MEM_SIZE=$(whiptail --title "è‡ªå®šä¹‰å†…å­˜å‚æ•°" --inputbox "è¯·è¾“å…¥æœåŠ¡å™¨å†…å­˜å¤§å°ï¼ˆæ ¼å¼ï¼š1G/2G/4Gï¼Œé»˜è®¤2Gï¼‰" 10 50 "2G" 3>&1 1>&2 2>&3)
    [[ ! "$MEM_SIZE" =~ [Gg]$ ]] && MEM_SIZE="${MEM_SIZE}G"
    echo -e "${YELLOW}[æç¤º] å·²è®¾ç½®æœåŠ¡å™¨å†…å­˜å‚æ•°ï¼š-Xmx$MEM_SIZE${RESET}"

    # 4. æ ¸å¿ƒä¿®æ”¹ï¼šç”Ÿæˆstart.shï¼ŒæŒ‰è¦æ±‚å†™å…¥javaå‘½ä»¤ï¼ˆä»…-Xmxå‚æ•°+æœåŠ¡ç«¯JARæ–‡ä»¶åï¼‰
    cat > "$INSTALL_DIR/start.sh" << EOF
#!/bin/bash
cd "$INSTALL_DIR"
echo "eula=true" > "$INSTALL_DIR/eula.txt"
# æŒ‰è¦æ±‚ä¿ç•™ï¼šä»…-Xmxå†…å­˜å‚æ•° + æœåŠ¡ç«¯å¯åŠ¨å™¨JARæ–‡ä»¶å + nogui
java -Xmx$MEM_SIZE -jar $CORE_JAR nogui
EOF
    chmod +x "$INSTALL_DIR/start.sh"
    echo -e "${GREEN}[æˆåŠŸ] å¯åŠ¨è„šæœ¬åˆ›å»ºå®Œæˆï¼Œè·¯å¾„ï¼š$INSTALL_DIR/start.sh${RESET}"
    echo -e "${GREEN}[è„šæœ¬å†…å®¹] javaå‘½ä»¤å·²ä¿å­˜ï¼šjava -Xmx$MEM_SIZE -jar $CORE_JAR nogui${RESET}"

    # 5. è‡ªåŠ¨å¯åŠ¨ï¼ˆä¿ç•™åŸé€»è¾‘ï¼‰
    echo -e "${BLUE}[å¯åŠ¨] $CORE_TYPE-$VERSION æ­£åœ¨å¯åŠ¨ï¼ˆå†…å­˜ï¼š$MEM_SIZEï¼‰...${RESET}"
    bash "$INSTALL_DIR/start.sh"
    [ $? -ne 0 ] && echo -e "${RED}[é”™è¯¯] å¯åŠ¨å¤±è´¥ï¼Œå¯æ‰‹åŠ¨æ‰§è¡Œ $INSTALL_DIR/start.sh æ’æŸ¥${RESET}" && sleep 3
}

plugin_store() {
    local CORE_TYPE_LIST=()
    local TARGET_CORES=("Paper" "Spigot" "Fabric")
    for CORE in "${TARGET_CORES[@]}"; do
        [ -d "$BASE_DIR/$CORE" ] && CORE_TYPE_LIST+=("$CORE" "$CORE")
    done
    [ ${#CORE_TYPE_LIST[@]} -eq 0 ] && {
        echo -e "${RED}[é”™è¯¯] $BASE_DIR ä¸‹æ— å·²å®‰è£…çš„Paper/Spigot/FabricæœåŠ¡ç«¯ï¼${RESET}"
        sleep 3 && return
    }

    SELECTED_CORE=$(whiptail --title "é€‰æ‹©æœåŠ¡ç«¯ç±»å‹" --menu "å·²å®‰è£…æœåŠ¡ç«¯ç±»å‹" 15 50 3 "${CORE_TYPE_LIST[@]}" 3>&1 1>&2 2>&3)
    [ -z "$SELECTED_CORE" ] && return

    local VER_LIST=()
    local CORE_PATH="$BASE_DIR/$SELECTED_CORE"
    for VER_DIR in "$CORE_PATH"/1.21.*; do
        [ -d "$VER_DIR" ] || continue
        local VER_NAME=$(basename "$VER_DIR")
        if [ -d "$VER_DIR/plugins" ]; then
            VER_LIST+=("$VER_DIR" "${SELECTED_CORE}-${VER_NAME}")
        else
            echo -e "${YELLOW}[æç¤º] ${SELECTED_CORE}-${VER_NAME} æ— pluginsæ–‡ä»¶å¤¹ï¼Œä¸å¯ä¸‹è½½æ’ä»¶${RESET}"
        fi
    done
    [ ${#VER_LIST[@]} -eq 0 ] && {
        echo -e "${RED}[é”™è¯¯] ${SELECTED_CORE} ä¸‹æ— å¸¦pluginsæ–‡ä»¶å¤¹çš„1.21ç‰ˆæœ¬ï¼${RESET}"
        sleep 3 && return
    }

    SELECTED_VER_DIR=$(whiptail --title "é€‰æ‹©ç‰ˆæœ¬" --menu "${SELECTED_CORE} å¯ä¸‹è½½æ’ä»¶çš„ç‰ˆæœ¬" 20 60 10 "${VER_LIST[@]}" 3>&1 1>&2 2>&3)
    [ -z "$SELECTED_VER_DIR" ] && return
    local PLUGIN_DIR="$SELECTED_VER_DIR/plugins"

    echo -e "${BLUE}[ä¸‹è½½] å¼€å§‹ä¸‹è½½ ${SELECTED_CORE} ç‰ˆGeyserï¼ˆç›®æ ‡è·¯å¾„ï¼š$PLUGIN_DIRï¼‰...${RESET}"
    if [ "$SELECTED_CORE" = "Fabric" ]; then
        wget --show-progress "https://download.geysermc.org/v2/projects/geyser/versions/2.8.4/builds/947/downloads/fabric" -O "$PLUGIN_DIR/Geyser-Fabric.jar"
    else
        wget --show-progress "https://download.geysermc.org/v2/projects/geyser/versions/latest/builds/latest/downloads/spigot" -O "$PLUGIN_DIR/Geyser-Spigot.jar"
    fi

    [ $? -eq 0 ] && echo -e "${GREEN}[æˆåŠŸ] Geyseræ’ä»¶å·²ä¸‹è½½è‡³ï¼š$PLUGIN_DIR${RESET}" || echo -e "${RED}[é”™è¯¯] Geyseræ’ä»¶ä¸‹è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•ï¼${RESET}"
    sleep 3
}

INSTALL_MC_SERVER_NEW() {
    check_system
    check_java
    while true; do
        MAIN_MENU=$(whiptail --title "MCæœåŠ¡å™¨ç®¡ç†ï¼ˆæ–°ï¼‰" --menu "åŠŸèƒ½æµ‹è¯•ä¸­ï¼Œä¸ä»£è¡¨æœ€ç»ˆå“è´¨" 15 50 3 \
            "1" "ğŸ“¦ å®‰è£…æœåŠ¡å™¨æ ¸å¿ƒ" "2" "ğŸ“¥ æ’ä»¶å•†åº—" "3" "ğŸŒš é€€å‡º" \
            3>&1 1>&2 2>&3)
        case $MAIN_MENU in
            1) install_core ;;
            2) plugin_store ;;
            3)
                echo -e "${BLUE}[é€€å‡º] 3ç§’åé€€å‡º...${RESET}"
                sleep 3 && clear && exit 0
                ;;
            *) clear && exit 0 ;;
        esac
    done
}

[[ "${BASH_SOURCE[0]}" == "$0" ]] && INSTALL_MC_SERVER_NEW
